<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Include SheetJS library from CDN -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .doc-output { /* Renamed for general use */
            border: 1px solid #e2e8f0;
            padding: 2rem;
            margin-top: 2rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none; /* Hide all initially */
        }
        .doc-output.active {
            display: block; /* Show only the active one */
        }
        .input-section {
             background-color: #f9fafb;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
             margin-bottom: 1rem; /* Reduced margin */
             display: none; /* Hide all initially */
        }
         .input-section.active {
            display: block; /* Show only the active one */
        }
        label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem; /* Slightly smaller labels */
        }
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 0.875rem;
        }
        textarea {
            min-height: 60px; /* Reduced height */
        }
        button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .btn-primary { background-color: #3b82f6; color: white; border: none; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; border: none; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-success { background-color: #10b981; color: white; border: none; } /* Green for Download now */
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; border: none; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; margin-bottom: 1rem; font-size: 0.875rem;}
        th, td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        th { background-color: #f3f4f6; font-weight: 600; }
        td.number-cell, th.number-cell { text-align: right; }
        .signature-area { margin-top: 2rem; border-top: 1px solid #e2e8f0; padding-top: 1rem; font-size: 0.875rem;}
        .signature-box { border-top: 1px dashed #9ca3af; padding-top: 0.5rem; margin-top: 1.5rem; text-align: center; }
        #download-status { margin-top: 1rem; text-align: center; font-weight: 500; font-size: 0.875rem;} /* Changed ID */
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-loading { color: #3b82f6; }
        .tab-button { background-color: #e5e7eb; color: #4b5563; border: 1px solid #d1d5db; border-bottom: none; }
        .tab-button.active { background-color: #f9fafb; color: #1f2937; border-bottom: 1px solid #f9fafb; margin-bottom: -1px; z-index: 10; position: relative;}
        .common-section { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;}
        .contract-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; }
        /* Added style for project name row */
        .project-name-row td { background-color: #f9fafb; font-style: italic; font-weight: 500; }


        /* Print styles */
        @media print {
             @page {
                 size: A4;
                 margin: 1cm; /* Adjust margin if needed */
                 @top-center { content: ""; }
                 @bottom-center { content: ""; }
                 @bottom-left { content: ""; }
                 @bottom-right { content: ""; }
             }

             body {
                 margin: 0 !important;
                 padding: 0 !important;
                 background-color: white;
                 font-family: 'Sarabun', sans-serif;
                 -webkit-print-color-adjust: exact !important;
                 color-adjust: exact !important;
                 font-size: 10pt; /* Can reduce slightly if needed, e.g., 9.5pt */
             }
             #page-title,
             #input-container,
             .action-button-container,
             #doc-type-selector,
             #download-status { display: none !important; }

             .doc-output {
                 border: none !important;
                 padding: 0 !important;
                 margin: 0 !important;
                 box-shadow: none !important;
                 width: 100% !important;
                 max-width: 100% !important;
                 display: block !important;
             }
             .doc-output:not(.active) { display: none !important; }
             table {
                 font-size: 9pt; /* Can reduce slightly */
                 page-break-inside: auto; /* Allow table rows to break if necessary */
             }
             tr {
                 page-break-inside: avoid; /* Try to keep rows together */
                 page-break-after: auto;
             }
             th, td { padding: 0.3rem; }
             /* Try to keep notes/terms block together and avoid breaking right after it */
             .output-notes-terms, .output-payment-details, .contract-section {
                 page-break-inside: avoid;
                 page-break-after: auto; /* Changed from avoid to auto, avoid can sometimes force breaks */
             }
             /* Try very hard to keep the signature area on one page */
             .signature-area {
                 margin-top: 1.5cm;
                 padding-top: 0.5cm;
                 border-top: 1px solid #ccc !important;
                 page-break-inside: avoid !important;
                 page-break-before: auto; /* Let browser decide if it needs to break before */
             }
             th, .project-name-row td { background-color: #f3f4f6 !important; print-color-adjust: exact !important; }
             h1, h2, h3 { color: black !important; page-break-after: avoid; } /* Avoid breaking after headings */
             .whitespace-pre-wrap { white-space: pre-wrap !important; }
             /* Hide remove button in print */
             .remove-item-btn { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto">
        <h1 id="page-title" class="text-2xl md:text-3xl font-bold mb-4 md:mb-6 text-center text-gray-800">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå</h1>

        <!-- Document Type Selector -->
        <div id="doc-type-selector" class="mb-4 flex justify-center border-b border-gray-300">
            <button class="tab-button px-4 py-2 rounded-t-md active" onclick="switchDocType('quotation')">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button>
            <button class="tab-button px-4 py-2 rounded-t-md" onclick="switchDocType('invoice')">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
            <button class="tab-button px-4 py-2 rounded-t-md" onclick="switchDocType('receipt')">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="tab-button px-4 py-2 rounded-t-md" onclick="switchDocType('contract')">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
            <button class="tab-button px-4 py-2 rounded-t-md" onclick="switchDocType('submission')">‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="input-container">
            <!-- Common Input Section -->
            <div class="common-section">
                 <h2 class="text-lg font-semibold mb-3 text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                         <h3 class="text-md font-medium mb-1 text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå/‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
                         <!-- Removed Logo Input -->
                         <label for="your-company">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ä‡∏∑‡πà‡∏≠:</label>
                         <input type="text" id="your-company" value="‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥" oninput="updateOutput(currentDocType)">
                          <label for="your-tax-id">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:</label>
                         <input type="text" id="your-tax-id" value="1-1103-01367-17-2" oninput="updateOutput(currentDocType)">
                         <label for="your-address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</label>
                         <textarea id="your-address" oninput="updateOutput(currentDocType)">61/315 ‡∏°.3 ‡∏°‡∏ö.‡πÑ‡∏£‡∏°‡∏≠‡∏ô‡∏û‡∏≤‡∏£‡πå‡∏Ñ ‡∏ã.‡∏ö‡∏≤‡∏á‡∏õ‡∏•‡∏≤ 12 ‡∏ñ.‡πÄ‡∏ó‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏ï.‡∏ö‡∏≤‡∏á‡∏õ‡∏•‡∏≤ ‡∏≠.‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏à.‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10540</textarea>
                         <label for="your-contact">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</label>
                         <input type="text" id="your-contact" value="083-149-4529, burist2016@gmail.com" oninput="updateOutput(currentDocType)">
                     </div>
                     <div>
                         <h3 class="text-md font-medium mb-1 text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                         <label for="customer-company">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</label>
                         <input type="text" id="customer-company" placeholder="RSC/‡∏™‡∏£‡∏ö." oninput="updateOutput(currentDocType)">
                          <label for="customer-tax-id">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:</label>
                         <input type="text" id="customer-tax-id" oninput="updateOutput(currentDocType)">
                         <label for="customer-contact-person">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠/‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                         <input type="text" id="customer-contact-person" oninput="updateOutput(currentDocType)">
                         <label for="customer-address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</label>
                         <textarea id="customer-address" oninput="updateOutput(currentDocType)"></textarea>
                           <label for="customer-tel">‡πÇ‡∏ó‡∏£:</label>
                         <input type="text" id="customer-tel" oninput="updateOutput(currentDocType)">
                     </div>
                 </div>
            </div>

            <!-- Input Section - Quotation -->
            <div id="input-quotation" class="input-section active">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="quotation-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:</label>
                        <input type="text" id="quotation-number" value="QT-RSC01-P1" oninput="updateOutput('quotation')">
                    </div>
                    <div>
                        <label for="quotation-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="quotation-date" oninput="updateOutput('quotation')">
                    </div>
                    <div>
                        <label for="quotation-currency">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô:</label>
                         <select id="quotation-currency" onchange="updateAllCalculations()">
                             <option value="‡∏ö‡∏≤‡∏ó" selected>‡∏ö‡∏≤‡∏ó (THB)</option>
                             <option value="USD">‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡∏™‡∏´‡∏£‡∏±‡∏ê (USD)</option>
                             <option value="EUR">‡∏¢‡∏π‡πÇ‡∏£ (EUR)</option>
                         </select>
                    </div>
                 </div>
                 <!-- Added Project Name Input -->
                 <div class="mb-4">
                     <label for="quotation-project-name">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏á‡∏≤‡∏ô:</label>
                     <input type="text" id="quotation-project-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å" oninput="updateOutput('quotation')">
                 </div>
                 <div class="items-container" data-doc-type="quotation"></div>
                 <button class="btn-secondary mt-2 text-sm" onclick="addItemRow('quotation')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                 <div class="mt-4">
                     <label for="quotation-discount-percent">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏° (%):</label>
                     <input type="number" id="quotation-discount-percent" min="0" max="100" step="0.01" value="0" oninput="updateOutput('quotation')" class="w-32">
                 </div>
                 <div class="totals-container mt-4 flex justify-end" data-doc-type="quotation"></div>
                 <div class="notes-terms-container grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" data-doc-type="quotation"></div>
                 <div class="signatures-container grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" data-doc-type="quotation"></div>
            </div>

            <!-- Input Section - Invoice -->
            <div id="input-invoice" class="input-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h2>
                 <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="invoice-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ:</label>
                        <input type="text" id="invoice-number" value="INV-" oninput="updateOutput('invoice')">
                    </div>
                    <div>
                        <label for="invoice-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="invoice-date" oninput="updateOutput('invoice')">
                    </div>
                     <div>
                        <label for="invoice-due-date">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</label>
                        <input type="date" id="invoice-due-date" oninput="updateOutput('invoice')">
                    </div>
                     <div>
                        <label for="invoice-ref-quotation">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:</label>
                        <input type="text" id="invoice-ref-quotation" oninput="updateOutput('invoice')">
                    </div>
                     <div>
                        <label for="invoice-currency">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô:</label>
                         <select id="invoice-currency" onchange="updateAllCalculations()">
                             <option value="‡∏ö‡∏≤‡∏ó" selected>‡∏ö‡∏≤‡∏ó (THB)</option>
                             <option value="USD">‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡∏™‡∏´‡∏£‡∏±‡∏ê (USD)</option>
                             <option value="EUR">‡∏¢‡∏π‡πÇ‡∏£ (EUR)</option>
                         </select>
                    </div>
                 </div>
                 <!-- Added Project Name Input -->
                 <div class="mb-4">
                     <label for="invoice-project-name">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏á‡∏≤‡∏ô:</label>
                     <input type="text" id="invoice-project-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å" oninput="updateOutput('invoice')">
                 </div>
                 <div class="items-container" data-doc-type="invoice"></div>
                 <button class="btn-secondary mt-2 text-sm" onclick="addItemRow('invoice')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                 <div class="totals-container mt-4 flex justify-end" data-doc-type="invoice"></div>
                 <div class="notes-terms-container grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" data-doc-type="invoice"></div>
                 <div class="signatures-container grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" data-doc-type="invoice"></div>
            </div>

            <!-- Input Section - Receipt -->
            <div id="input-receipt" class="input-section">
                 <h2 class="text-xl font-semibold mb-4 text-gray-700">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>
                 <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="receipt-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</label>
                        <input type="text" id="receipt-number" value="RE-" oninput="updateOutput('receipt')">
                    </div>
                    <div>
                        <label for="receipt-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</label>
                        <input type="date" id="receipt-date" oninput="updateOutput('receipt')">
                    </div>
                     <div>
                        <label for="receipt-ref-invoice">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•/‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ:</label>
                        <input type="text" id="receipt-ref-invoice" oninput="updateOutput('receipt')">
                    </div>
                     <div>
                        <label for="receipt-currency">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô:</label>
                         <select id="receipt-currency" onchange="updateAllCalculations()">
                             <option value="‡∏ö‡∏≤‡∏ó" selected>‡∏ö‡∏≤‡∏ó (THB)</option>
                             <option value="USD">‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡∏™‡∏´‡∏£‡∏±‡∏ê (USD)</option>
                             <option value="EUR">‡∏¢‡∏π‡πÇ‡∏£ (EUR)</option>
                         </select>
                    </div>
                 </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                        <h3 class="text-md font-medium mb-1 text-gray-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h3>
                         <label>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢:</label>
                         <div class="flex space-x-4 mb-2">
                             <label class="inline-flex items-center"><input type="radio" name="payment-method" value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" class="mr-1 !w-auto !mb-0" onchange="updateOutput('receipt')" checked> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
                             <label class="inline-flex items-center"><input type="radio" name="payment-method" value="‡πÄ‡∏ä‡πá‡∏Ñ" class="mr-1 !w-auto !mb-0" onchange="updateOutput('receipt')"> ‡πÄ‡∏ä‡πá‡∏Ñ</label>
                             <label class="inline-flex items-center"><input type="radio" name="payment-method" value="‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="mr-1 !w-auto !mb-0" onchange="updateOutput('receipt')"> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                             <label class="inline-flex items-center"><input type="radio" name="payment-method" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="mr-1 !w-auto !mb-0" onchange="updateOutput('receipt')"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                         </div>
                         <label for="receipt-payment-details">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ä‡πá‡∏Ñ/‡πÇ‡∏≠‡∏ô (‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£, ‡∏™‡∏≤‡∏Ç‡∏≤, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà):</label>
                         <textarea id="receipt-payment-details" oninput="updateOutput('receipt')"></textarea>
                     </div>
                 </div>
                  <!-- Added Project Name Input -->
                 <div class="mb-4">
                     <label for="receipt-project-name">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏á‡∏≤‡∏ô:</label>
                     <input type="text" id="receipt-project-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å" oninput="updateOutput('receipt')">
                 </div>
                 <div class="items-container" data-doc-type="receipt"></div>
                 <button class="btn-secondary mt-2 text-sm" onclick="addItemRow('receipt')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                 <div class="totals-container mt-4 flex justify-end" data-doc-type="receipt"></div>
                 <div class="notes-terms-container grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" data-doc-type="receipt"></div>
                 <div class="signatures-container grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" data-doc-type="receipt"></div>
            </div>

             <!-- Input Section - Contract -->
            <div id="input-contract" class="input-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="contract-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</label>
                        <input type="text" id="contract-number" value="CON-" oninput="updateOutput('contract')">
                    </div>
                    <div>
                        <label for="contract-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</label>
                        <input type="date" id="contract-date" oninput="updateOutput('contract')">
                    </div>
                </div>
                 <div class="grid grid-cols-1 gap-4 mb-4">
                     <div>
                         <label for="contract-scope">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô (Scope of Work):</label>
                         <textarea id="contract-scope" rows="4" oninput="updateOutput('contract')"></textarea>
                     </div>
                     <div>
                         <label for="contract-timeline">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                         <textarea id="contract-timeline" rows="2" oninput="updateOutput('contract')"></textarea>
                     </div>
                     <div>
                         <label for="contract-payment">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label>
                         <textarea id="contract-payment" rows="3" oninput="updateOutput('contract')"></textarea>
                     </div>
                     <div>
                         <label for="contract-revisions">‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô:</label>
                         <textarea id="contract-revisions" rows="2" oninput="updateOutput('contract')"></textarea>
                     </div>
                     <div>
                         <label for="contract-cancellation">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</label>
                         <textarea id="contract-cancellation" rows="2" oninput="updateOutput('contract')"></textarea>
                     </div>
                     <div>
                         <label for="contract-copyright">‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô:</label>
                         <textarea id="contract-copyright" rows="2" oninput="updateOutput('contract')"></textarea>
                     </div>
                      <div>
                         <label for="contract-contact">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ / ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
                         <textarea id="contract-contact" rows="2" oninput="updateOutput('contract')"></textarea>
                     </div>
                 </div>
                  <div class="signatures-container grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" data-doc-type="contract"></div>
            </div>

            <!-- Input Section - Submission -->
            <div id="input-submission" class="input-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                     <div>
                        <label for="submission-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</label>
                        <input type="text" id="submission-number" value="SUB-" oninput="updateOutput('submission')">
                    </div>
                    <div>
                        <label for="submission-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö:</label>
                        <input type="date" id="submission-date" oninput="updateOutput('submission')">
                    </div>
                     <div>
                        <label for="submission-project">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå / ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á:</label>
                        <input type="text" id="submission-project" oninput="updateOutput('submission')">
                    </div>
                </div>
                 <div class="grid grid-cols-1 gap-4 mb-4">
                     <div>
                         <label for="submission-items">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á (‡πÑ‡∏ü‡∏•‡πå, ‡∏•‡∏¥‡∏á‡∏Å‡πå, ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô):</label>
                         <textarea id="submission-items" rows="5" oninput="updateOutput('submission')"></textarea>
                     </div>
                     <div>
                         <label for="submission-notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
                         <textarea id="submission-notes" rows="3" oninput="updateOutput('submission')"></textarea>
                     </div>
                 </div>
                 <div class="signatures-container grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" data-doc-type="submission"></div>
            </div>


            <!-- Action Buttons -->
            <div class="action-button-container mt-6 text-center space-x-4">
                <button id="download-button" onclick="downloadExcel()" class="btn-success">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô Excel (.xlsx)</button>
                <button onclick="window.print()" class="btn-primary">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                <button onclick="clearSavedData()" class="btn-danger" title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
             <!-- Download Status Area -->
            <div id="download-status" class="mt-4 text-center font-medium"></div>
        </div>


        <!-- Output/Preview Section - Quotation -->
        <div id="output-quotation" class="doc-output active">
             <div class="output-header grid grid-cols-2 gap-8 mb-8"></div>
             <div class="output-customer mb-8 p-4 bg-gray-50 rounded border border-gray-200"></div>
             <table class="table-auto output-table">
                <thead></thead>
                <tbody></tbody>
            </table>
             <div class="output-totals flex justify-end mt-4 mb-4"></div>
             <div class="output-notes-terms grid grid-cols-1 md:grid-cols-2 gap-8 text-sm mt-8"></div>
             <div class="output-signatures signature-area grid grid-cols-2 gap-16"></div>
        </div>

        <!-- Output/Preview Section - Invoice -->
        <div id="output-invoice" class="doc-output">
             <div class="output-header grid grid-cols-2 gap-8 mb-8"></div>
             <div class="output-customer mb-8 p-4 bg-gray-50 rounded border border-gray-200"></div>
             <table class="table-auto output-table">
                <thead></thead>
                <tbody></tbody>
            </table>
             <div class="output-totals flex justify-end mt-4 mb-4"></div>
             <div class="output-notes-terms grid grid-cols-1 md:grid-cols-1 gap-8 text-sm mt-8"></div>
             <div class="output-signatures signature-area grid grid-cols-3 gap-8"></div>
        </div>

         <!-- Output/Preview Section - Receipt -->
        <div id="output-receipt" class="doc-output">
            <div class="output-header grid grid-cols-2 gap-8 mb-8"></div>
             <div class="output-customer mb-8 p-4 bg-gray-50 rounded border border-gray-200"></div>
             <table class="table-auto output-table">
                <thead></thead>
                <tbody></tbody>
            </table>
             <div class="output-totals flex justify-end mt-4 mb-4"></div>
             <div class="output-payment-details grid grid-cols-1 md:grid-cols-2 gap-8 text-sm mt-8 border-t pt-4"></div>
             <div class="output-notes-terms grid grid-cols-1 md:grid-cols-1 gap-8 text-sm mt-4"></div>
             <div class="output-signatures signature-area grid grid-cols-3 gap-8"></div>
        </div>

        <!-- Output/Preview Section - Contract -->
        <div id="output-contract" class="doc-output">
            <h2 class="text-2xl font-bold text-center mb-6">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞</h2>
            <div class="grid grid-cols-2 gap-8 mb-6 text-sm">
                <div>
                    <p><span class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</span> <span class="output-contract-number"></span></p>
                </div>
                <div class="text-right">
                    <p><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</span> <span class="output-contract-date"></span></p>
                </div>
            </div>
             <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</h3>
                    <p class="font-medium output-customer-company"></p>
                    <p class="text-gray-600 output-customer-tax-id"></p>
                    <p class="text-gray-600 whitespace-pre-wrap output-customer-address"></p>
                    <p class="text-gray-600 output-customer-contact-person"></p>
                     <p class="text-gray-600 output-customer-tel"></p>
                </div>
                 <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á</h3>
                    <p class="font-medium output-your-company"></p>
                    <p class="text-gray-600 output-your-tax-id"></p>
                    <p class="text-gray-600 whitespace-pre-wrap output-your-address"></p>
                    <p class="text-gray-600 output-your-contact"></p>
                </div>
            </div>

            <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">1. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô (Scope of Work)</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-scope"></p>
            </div>
            <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-timeline"></p>
            </div>
             <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">3. ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-payment"></p>
            </div>
            <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">4. ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-revisions"></p>
            </div>
             <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">5. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-cancellation"></p>
            </div>
             <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">6. ‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-copyright"></p>
            </div>
             <div class="contract-section">
                <h3 class="font-semibold text-lg mb-2">7. ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ / ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h3>
                <p class="text-sm whitespace-pre-wrap output-contract-contact"></p>
            </div>

             <div class="output-signatures signature-area grid grid-cols-2 gap-16 mt-8">
                  <div class="text-center">
                     <p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</p>
                     <div class="signature-box mt-12">( <span class="output-contract-client-name"></span> )</div>
                     <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ...........................................</p> <!-- Blank Date -->
                 </div>
                 <div class="text-center">
                     <p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á</p>
                    <div class="signature-box mt-12">( <span class="output-contract-freelancer-name"></span> )</div>
                     <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="output-contract-signed-date"></span></p>
                 </div>
             </div>
        </div>

        <!-- Output/Preview Section - Submission -->
        <div id="output-submission" class="doc-output">
             <div class="output-header grid grid-cols-2 gap-8 mb-8"></div>
             <h2 class="text-2xl font-bold text-center mb-4">‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</h2>
             <div class="grid grid-cols-2 gap-8 mb-6 text-sm">
                 <div>
                    <p><span class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</span> <span class="output-submission-number"></span></p>
                    <p><span class="font-semibold">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå:</span> <span class="output-submission-project"></span></p>
                </div>
                <div class="text-right">
                    <p><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö:</span> <span class="output-submission-date"></span></p>
                </div>
             </div>
              <div class="output-customer mb-6 p-4 bg-gray-50 rounded border border-gray-200 text-sm"></div>

              <div>
                 <h3 class="font-semibold text-lg mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö:</h3>
                 <div class="text-sm whitespace-pre-wrap border p-4 rounded output-submission-items bg-white"></div>
              </div>

               <div class="mt-4">
                 <h3 class="font-semibold text-lg mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</h3>
                 <p class="text-sm whitespace-pre-wrap output-submission-notes"></p>
              </div>

             <div class="output-signatures signature-area grid grid-cols-2 gap-16 mt-8">
                 <div class="text-center">
                     <p>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</p>
                    <div class="signature-box mt-12">( <span class="output-submission-submitter-name"></span> )</div>
                     <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="output-submission-submit-date"></span></p>
                 </div>
                  <div class="text-center">
                     <p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</p>
                     <div class="signature-box mt-12">( <span class="output-submission-receiver-name"></span> )</div>
                     <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ...........................................</p> <!-- Blank Date -->
                 </div>
            </div>
        </div>


    </div>

    <script>
        let currentDocType = 'quotation';
        const currencySymbolMap = { '‡∏ö‡∏≤‡∏ó': '‡∏ö‡∏≤‡∏ó', 'USD': '$', 'EUR': '‚Ç¨' };

        // --- Utility Functions (formatCurrency, bahtText, formatDateThai) ---
         function formatCurrency(number, currencyCode = '‡∏ö‡∏≤‡∏ó') {
            if (isNaN(number) || number === null) return '0.00';
            const numStr = parseFloat(number).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            // Append currency unit for all cases now
            return `${numStr} ${currencySymbolMap[currencyCode] || currencyCode}`;
        }

        function bahtText(number) {
             number = Number(number);
            if (isNaN(number) || number === 0) return "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô";

            number = number.toFixed(2);
            let [baht, satang] = number.split('.');
            baht = BigInt(baht);

            const txtNumArr = ["", "‡∏´‡∏ô‡∏∂‡πà‡∏á", "‡∏™‡∏≠‡∏á", "‡∏™‡∏≤‡∏°", "‡∏™‡∏µ‡πà", "‡∏´‡πâ‡∏≤", "‡∏´‡∏Å", "‡πÄ‡∏à‡πá‡∏î", "‡πÅ‡∏õ‡∏î", "‡πÄ‡∏Å‡πâ‡∏≤", "‡∏™‡∏¥‡∏ö"];
            const txtDigitArr = ["", "‡∏™‡∏¥‡∏ö", "‡∏£‡πâ‡∏≠‡∏¢", "‡∏û‡∏±‡∏ô", "‡∏´‡∏°‡∏∑‡πà‡∏ô", "‡πÅ‡∏™‡∏ô", "‡∏•‡πâ‡∏≤‡∏ô"];
            let bahtText = "";

            if (baht === 0n) {}
             else if (baht < 0n) { bahtText = "‡∏•‡∏ö"; baht = -baht; }

            const bahtStr = baht.toString();
            const bahtLen = bahtStr.length;

            for (let i = 0; i < bahtLen; i++) {
                const digit = BigInt(bahtStr[i]);
                if (digit === 0n) continue;
                const position = bahtLen - 1 - i;
                const digitPosition = position % 6;
                const millionPosition = Math.floor(position / 6);
                let digitWord = txtNumArr[Number(digit)];
                if (digitPosition === 1 && digit === 2n) digitWord = "‡∏¢‡∏µ‡πà";
                if (digitPosition === 1 && digit === 1n) digitWord = "";
                if (position > 0 && digitPosition === 0 && digit === 1n && (bahtLen > 1 && bahtStr[i-1] !== '0')) digitWord = "‡πÄ‡∏≠‡πá‡∏î";
                if (digitPosition === 0 && digit === 1n && bahtLen === 1) digitWord = "‡∏´‡∏ô‡∏∂‡πà‡∏á";
                bahtText += digitWord + (digitPosition > 0 ? txtDigitArr[digitPosition] : "");
                if (millionPosition > 0 && digitPosition === 0) bahtText += txtDigitArr[6];
            }
            bahtText = bahtText.replace(/‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡∏¥‡∏ö(?=($|‡∏•‡πâ‡∏≤‡∏ô))/g, '‡∏™‡∏¥‡∏ö');
            bahtText += "‡∏ö‡∏≤‡∏ó";

            if (satang && Number(satang) > 0) {
                satang = Number(satang);
                let satangText = "";
                const satangStr = satang.toString().padStart(2, '0');
                const tenDigit = Number(satangStr[0]);
                const unitDigit = Number(satangStr[1]);
                if(tenDigit > 0) {
                    satangText += (tenDigit === 2 ? "‡∏¢‡∏µ‡πà" : (tenDigit === 1 ? "" : txtNumArr[tenDigit])) + txtDigitArr[1];
                }
                if(unitDigit > 0) {
                     satangText += (unitDigit === 1 && tenDigit > 0) ? "‡πÄ‡∏≠‡πá‡∏î" : txtNumArr[unitDigit];
                }
                bahtText += satangText + "‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå";
            } else { bahtText += "‡∏ñ‡πâ‡∏ß‡∏ô"; }
            return bahtText;
        }

        function formatDateThai(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
            } catch (e) { console.error("Error formatting date:", e); return ''; }
        }

        // --- Item Row Management (generateItemRowHTML, addItemRow, removeItemRow, addEventListenersToRow) ---
         // Updated Item Row HTML to include Quantity label clearly
         function generateItemRowHTML(docType) {
            return `
                <div class="item-row grid grid-cols-12 gap-2 mb-2 items-center border-b pb-2">
                    <div class="col-span-12 md:col-span-4"><label class="text-xs">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="text" class="item-description" placeholder="‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="updateOutput('${docType}')"></div>
                    <div class="col-span-4 md:col-span-1"><label class="text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" class="item-quantity" placeholder="1" step="any" min="0" value="1" oninput="calculateRowTotal(this); updateOutput('${docType}')"></div>
                    <div class="col-span-4 md:col-span-1"><label class="text-xs">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input type="text" class="item-unit" placeholder="‡∏á‡∏≤‡∏ô" oninput="updateOutput('${docType}')"></div>
                    <div class="col-span-4 md:col-span-2"><label class="text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input type="number" class="item-price" placeholder="0.00" step="0.01" min="0" oninput="calculateRowTotal(this); updateOutput('${docType}')"></div>
                     <div class="col-span-4 md:col-span-2"><label class="text-xs">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label><input type="number" class="item-discount" placeholder="0.00" step="0.01" min="0" oninput="calculateRowTotal(this); updateOutput('${docType}')"></div>
                    <div class="col-span-6 md:col-span-1"><label class="text-xs">‡∏£‡∏ß‡∏°</label><span class="item-total text-right block pt-6 pr-1 text-sm">0.00 ‡∏ö‡∏≤‡∏ó</span></div>
                    <div class="col-span-6 md:col-span-1 flex items-end justify-center pb-2"><button class="btn-danger text-xs py-1 px-2 remove-item-btn">‡∏•‡∏ö</button></div>
                </div>`;
        }

        // Function to add event listeners to a specific item row
        function addEventListenersToRow(rowElement) {
             const docType = rowElement.closest('.input-section')?.id.replace('input-', '') || currentDocType;
             rowElement.querySelectorAll('.item-quantity, .item-price, .item-discount').forEach(input => {
                 input.addEventListener('input', () => calculateRowTotal(input));
             });
             rowElement.querySelectorAll('.item-description, .item-unit').forEach(input => {
                 input.addEventListener('input', () => updateOutput(docType));
             });
             const removeBtn = rowElement.querySelector('.remove-item-btn');
             if (removeBtn && !removeBtn.getAttribute('data-listener-added')) {
                 removeBtn.addEventListener('click', () => removeItemRow(removeBtn));
                 removeBtn.setAttribute('data-listener-added', 'true');
             }
        }


        function addItemRow(docType) {
             if (docType === 'contract' || docType === 'submission') return;
            const itemList = document.querySelector(`#input-${docType} .items-container`);
            itemList.insertAdjacentHTML('beforeend', generateItemRowHTML(docType));
            const newRow = itemList.lastElementChild;
            addEventListenersToRow(newRow); // Use the new function here
            updateOutput(docType);
            saveFormData(); // Auto-save when adding row
        }

        function removeItemRow(button) {
             if (!button) return;
             const row = button.closest('.item-row'); if (!row) return;
             const container = row.parentElement; if (!container) return;
             const inputSection = container.closest('.input-section'); if (!inputSection) return;
             const docType = inputSection.id.replace('input-', '');

             if (container.querySelectorAll('.item-row').length > 1) { row.remove(); }
             else {
                 row.querySelectorAll('input').forEach(input => {
                     if (input.classList.contains('item-quantity')) input.value = '1';
                     else if (input.type === 'number') input.value = '';
                     else input.value = '';
                 });
                 const currencyCode = document.getElementById(`${docType}-currency`)?.value || '‡∏ö‡∏≤‡∏ó';
                 row.querySelector('.item-total').textContent = formatCurrency(0, currencyCode);
             }
             calculateDocTotals(docType); updateOutput(docType); saveFormData();
        }

        // --- Calculation Functions (calculateRowTotal, calculateDocTotals, updateAllCalculations) ---
         function calculateRowTotal(inputElement) {
            const row = inputElement.closest('.item-row'); if (!row) return;
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
            const total = (price * quantity) - discount;
             const currencyCode = document.getElementById(`${currentDocType}-currency`)?.value || '‡∏ö‡∏≤‡∏ó';
            const itemTotalEl = row.querySelector('.item-total');
            if (itemTotalEl) itemTotalEl.textContent = formatCurrency(total, currencyCode);
            calculateDocTotals(currentDocType);
        }

        function calculateDocTotals(docType) {
            if (docType === 'contract' || docType === 'submission') return;
            let subTotal = 0;
            const currencyCode = document.getElementById(`${docType}-currency`)?.value || '‡∏ö‡∏≤‡∏ó';
            const container = document.querySelector(`#input-${docType}`); if (!container) return;
            container.querySelectorAll('.item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
                subTotal += (price * quantity) - discount;
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
            let totalDiscount = 0;
            let netTotal = subTotal;
            if (docType === 'quotation') {
                const discountPercent = parseFloat(document.getElementById('quotation-discount-percent')?.value) || 0;
                totalDiscount = (subTotal * discountPercent) / 100;
                netTotal = subTotal - totalDiscount;
            }

            const totalsContainer = container.querySelector('.totals-container'); if (!totalsContainer) return;
            const grandTotalEl = totalsContainer.querySelector('.grand-total'); // Represents Subtotal
            const discountEl = totalsContainer.querySelector('.total-discount'); // Discount amount
            const netTotalEl = totalsContainer.querySelector('.net-total');
            const totalWordsEl = totalsContainer.querySelector('.total-in-words');

            if(grandTotalEl) grandTotalEl.textContent = formatCurrency(subTotal, currencyCode);
            if(discountEl) discountEl.textContent = formatCurrency(totalDiscount, currencyCode);
            if(netTotalEl) netTotalEl.textContent = formatCurrency(netTotal, currencyCode);
            if(totalWordsEl) totalWordsEl.textContent = (currencyCode === '‡∏ö‡∏≤‡∏ó') ? `(${bahtText(netTotal)})` : '';
        }


        function updateAllCalculations() {
            calculateDocTotals('quotation'); calculateDocTotals('invoice'); calculateDocTotals('receipt');
            updateOutput(currentDocType);
        }

        // --- localStorage Functions for Data Persistence ---
        function saveFormData() {
            const formData = {
                // Common data
                yourCompany: document.getElementById('your-company').value,
                yourTaxId: document.getElementById('your-tax-id').value,
                yourAddress: document.getElementById('your-address').value,
                yourContact: document.getElementById('your-contact').value,
                customerCompany: document.getElementById('customer-company').value,
                customerTaxId: document.getElementById('customer-tax-id').value,
                customerContactPerson: document.getElementById('customer-contact-person').value,
                customerAddress: document.getElementById('customer-address').value,
                customerTel: document.getElementById('customer-tel').value,
                
                // Document-specific data
                quotation: collectDocumentData('quotation'),
                invoice: collectDocumentData('invoice'),
                receipt: collectDocumentData('receipt'),
                contract: collectDocumentData('contract'),
                submission: collectDocumentData('submission')
            };
            
            try {
                localStorage.setItem('freelanceDocData', JSON.stringify(formData));
            } catch (e) {
                console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', e);
            }
        }

        function collectDocumentData(docType) {
            const inputSection = document.getElementById(`input-${docType}`);
            if (!inputSection) return null;
            
            const data = {};
            
            // Collect all input, textarea, and select values
            inputSection.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        data[el.id] = el.checked;
                    } else {
                        data[el.id] = el.value;
                    }
                } else if (el.className) {
                    // Save by class name for dynamically generated inputs
                    const key = el.className.split(' ')[0];
                    if (!data[key]) data[key] = [];
                    data[key].push(el.value);
                }
            });
            
            // Collect item rows for quotation, invoice, receipt
            if (['quotation', 'invoice', 'receipt'].includes(docType)) {
                const items = [];
                inputSection.querySelectorAll('.item-row').forEach(row => {
                    items.push({
                        description: row.querySelector('.item-description')?.value || '',
                        quantity: row.querySelector('.item-quantity')?.value || '1',
                        unit: row.querySelector('.item-unit')?.value || '',
                        price: row.querySelector('.item-price')?.value || '',
                        discount: row.querySelector('.item-discount')?.value || '0'
                    });
                });
                data.items = items;
            }
            
            return data;
        }

        function loadFormData() {
            try {
                const savedData = localStorage.getItem('freelanceDocData');
                if (!savedData) return;
                
                const formData = JSON.parse(savedData);
                
                // Restore common data
                if (formData.yourCompany) document.getElementById('your-company').value = formData.yourCompany;
                if (formData.yourTaxId) document.getElementById('your-tax-id').value = formData.yourTaxId;
                if (formData.yourAddress) document.getElementById('your-address').value = formData.yourAddress;
                if (formData.yourContact) document.getElementById('your-contact').value = formData.yourContact;
                if (formData.customerCompany) document.getElementById('customer-company').value = formData.customerCompany;
                if (formData.customerTaxId) document.getElementById('customer-tax-id').value = formData.customerTaxId;
                if (formData.customerContactPerson) document.getElementById('customer-contact-person').value = formData.customerContactPerson;
                if (formData.customerAddress) document.getElementById('customer-address').value = formData.customerAddress;
                if (formData.customerTel) document.getElementById('customer-tel').value = formData.customerTel;
                
                // Restore document-specific data
                ['quotation', 'invoice', 'receipt', 'contract', 'submission'].forEach(docType => {
                    if (formData[docType]) {
                        restoreDocumentData(docType, formData[docType]);
                    }
                });
                
            } catch (e) {
                console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ:', e);
            }
        }

        function restoreDocumentData(docType, data) {
            const inputSection = document.getElementById(`input-${docType}`);
            if (!inputSection || !data) return;
            
            // Restore simple inputs
            Object.keys(data).forEach(key => {
                if (key === 'items') return; // Handle items separately
                
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = data[key];
                    } else {
                        el.value = data[key];
                    }
                }
            });
            
            // Restore item rows
            if (data.items && data.items.length > 0) {
                const itemsContainer = inputSection.querySelector('.items-container');
                if (itemsContainer) {
                    // Clear existing rows
                    itemsContainer.innerHTML = '';
                    
                    // Add saved items
                    data.items.forEach((item, index) => {
                        if (index > 0) addItemRow(docType); // First row already exists
                        else itemsContainer.innerHTML = generateItemRowHTML(docType);
                        
                        const row = itemsContainer.children[itemsContainer.children.length - 1];
                        if (row) {
                            const descEl = row.querySelector('.item-description');
                            const qtyEl = row.querySelector('.item-quantity');
                            const unitEl = row.querySelector('.item-unit');
                            const priceEl = row.querySelector('.item-price');
                            const discEl = row.querySelector('.item-discount');
                            
                            if (descEl) descEl.value = item.description;
                            if (qtyEl) qtyEl.value = item.quantity;
                            if (unitEl) unitEl.value = item.unit;
                            if (priceEl) priceEl.value = item.price;
                            if (discEl) discEl.value = item.discount;
                            
                            addEventListenersToRow(row);
                            if (qtyEl) calculateRowTotal(qtyEl);
                        }
                    });
                }
            }
        }

        function clearSavedData() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.removeItem('freelanceDocData');
                location.reload();
            }
        }

        // --- Update Output Functions (updateCommonOutput, updateOutput) ---
         function updateCommonOutput(outputSection) {
             // Removed Logo update
             const yourCompanyEl = outputSection.querySelector('.output-your-company');
             const yourTaxIdEl = outputSection.querySelector('.output-your-tax-id');
             const yourAddressEl = outputSection.querySelector('.output-your-address');
             const yourContactEl = outputSection.querySelector('.output-your-contact');
             const customerCompanyEl = outputSection.querySelector('.output-customer-company');
             const customerTaxIdEl = outputSection.querySelector('.output-customer-tax-id');
             const customerContactEl = outputSection.querySelector('.output-customer-contact-person');
             const customerAddressEl = outputSection.querySelector('.output-customer-address');
             const customerTelEl = outputSection.querySelector('.output-customer-tel');

             if(yourCompanyEl) yourCompanyEl.textContent = document.getElementById('your-company').value;
             if(yourTaxIdEl) yourTaxIdEl.textContent = document.getElementById('your-tax-id').value ? `‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${document.getElementById('your-tax-id').value}`: '';
             if(yourAddressEl) yourAddressEl.textContent = document.getElementById('your-address').value;
             if(yourContactEl) yourContactEl.textContent = document.getElementById('your-contact').value;
             if(customerCompanyEl) customerCompanyEl.textContent = document.getElementById('customer-company').value;
             if(customerTaxIdEl) customerTaxIdEl.textContent = document.getElementById('customer-tax-id').value ? `‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${document.getElementById('customer-tax-id').value}`: '';
             if(customerContactEl) customerContactEl.textContent = document.getElementById('customer-contact-person').value ? `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${document.getElementById('customer-contact-person').value}` : '';
             if(customerAddressEl) customerAddressEl.textContent = document.getElementById('customer-address').value;
             if(customerTelEl) customerTelEl.textContent = document.getElementById('customer-tel').value ? `‡πÇ‡∏ó‡∏£: ${document.getElementById('customer-tel').value}` : '';
        }

         function updateOutput(docType) {
             const inputSection = document.getElementById(`input-${docType}`);
             const outputSection = document.getElementById(`output-${docType}`);
             if (!inputSection || !outputSection) return;
             
             // Auto-save when output is updated
             if (typeof saveFormData === 'function') {
                 saveFormData();
             }
             let currencyCode = '‡∏ö‡∏≤‡∏ó'; let docTitle = ''; let docNumber = ''; let docDate = '';
             let dueDate = ''; let refQuotation = ''; let refInvoice = ''; let projectName = '';
             let rawConDate = ''; let rawSubDate = '';
             const currencySelect = document.getElementById(`${docType}-currency`);
             if (currencySelect) { currencyCode = currencySelect.value; }
             const headerContainer = outputSection.querySelector('.output-header');
             const customerContainer = outputSection.querySelector('.output-customer');

             if (headerContainer) {
                 if (docType === 'quotation') { docTitle = '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'; docNumber = inputSection.querySelector('#quotation-number')?.value || ''; docDate = inputSection.querySelector('#quotation-date')?.value || ''; projectName = inputSection.querySelector('#quotation-project-name')?.value || ''; }
                 else if (docType === 'invoice') { docTitle = '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ'; docNumber = inputSection.querySelector('#invoice-number')?.value || ''; docDate = inputSection.querySelector('#invoice-date')?.value || ''; dueDate = inputSection.querySelector('#invoice-due-date')?.value || ''; refQuotation = inputSection.querySelector('#invoice-ref-quotation')?.value || ''; projectName = inputSection.querySelector('#invoice-project-name')?.value || ''; }
                 else if (docType === 'receipt') { docTitle = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô'; docNumber = inputSection.querySelector('#receipt-number')?.value || ''; docDate = inputSection.querySelector('#receipt-date')?.value || ''; refInvoice = inputSection.querySelector('#receipt-ref-invoice')?.value || ''; projectName = inputSection.querySelector('#receipt-project-name')?.value || ''; }
                 else if (docType === 'submission') { docNumber = inputSection.querySelector('#submission-number')?.value || ''; docDate = inputSection.querySelector('#submission-date')?.value || ''; projectName = inputSection.querySelector('#submission-project')?.value || ''; rawSubDate = docDate; }
                 else if (docType === 'contract') { docNumber = inputSection.querySelector('#contract-number')?.value || ''; rawConDate = inputSection.querySelector('#contract-date')?.value || ''; docDate = rawConDate; }

                 if (docType !== 'contract' && docType !== 'submission') {
                       // Removed Logo div, adjusted grid
                      headerContainer.innerHTML = `<div class="col-span-1"><p class="font-semibold text-lg output-your-company"></p><p class="text-sm text-gray-600 output-your-tax-id"></p><p class="text-sm text-gray-600 whitespace-pre-wrap output-your-address"></p><p class="text-sm text-gray-600 output-your-contact"></p></div><div class="text-right"><h2 class="text-2xl font-bold mb-2">${docTitle}</h2><p class="mb-1"><span class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span> <span class="output-doc-number">${docNumber}</span></p><p class="mb-1"><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> <span class="output-doc-date">${formatDateThai(docDate)}</span></p>${dueDate ? `<p class="mb-1"><span class="font-semibold">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</span> <span class="output-due-date">${formatDateThai(dueDate)}</span></p>` : ''}${refQuotation ? `<p class="mb-1"><span class="font-semibold">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:</span> <span class="output-ref-quotation">${refQuotation}</span></p>` : ''}${refInvoice ? `<p class="mb-1"><span class="font-semibold">‡πÉ‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•:</span> <span class="output-ref-invoice">${refInvoice}</span></p>` : ''}</div>`;
                 } else if (docType === 'submission') {
                      // Removed Logo div for submission
                     headerContainer.innerHTML = `<div class="col-span-1"><p class="font-semibold text-lg output-your-company"></p><p class="text-sm text-gray-600 output-your-tax-id"></p><p class="text-sm text-gray-600 whitespace-pre-wrap output-your-address"></p><p class="text-sm text-gray-600 output-your-contact"></p></div><div></div>`;
                 } else { headerContainer.innerHTML = ''; } // Contract has no header section like this
                 updateCommonOutput(outputSection);
             }

            if (customerContainer) {
                 let customerTitle = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
                 if (docType === 'quotation') customerTitle = '‡πÄ‡∏™‡∏ô‡∏≠'; else if (docType === 'contract') customerTitle = '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)'; else if (docType === 'submission') customerTitle = '‡∏ñ‡∏∂‡∏á';
                customerContainer.innerHTML = `<h3 class="font-semibold mb-1">${customerTitle}</h3><p class="font-medium output-customer-company"></p><p class="text-sm text-gray-600 output-customer-tax-id"></p><p class="text-sm text-gray-600 output-customer-contact-person"></p><p class="text-sm text-gray-600 whitespace-pre-wrap output-customer-address"></p><p class="text-sm text-gray-600 output-customer-tel"></p>`;
                 updateCommonOutput(outputSection);
            }

            if (docType === 'quotation' || docType === 'invoice' || docType === 'receipt') {
                const outputTableBody = outputSection.querySelector('.output-table tbody');
                const outputTableHeader = outputSection.querySelector('.output-table thead');
                if (!outputTableBody || !outputTableHeader) return;
                outputTableBody.innerHTML = ''; let itemIndex = 1;
                 // Updated Table Header to include Quantity
                outputTableHeader.innerHTML = (docType === 'quotation') ? `<tr><th class="w-8">#</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="w-12 number-cell">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="w-16">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="w-24 number-cell">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="w-24 number-cell">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr>` : `<tr><th class="w-8">#</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="w-12 number-cell">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="w-16">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="w-24 number-cell">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="w-20 number-cell">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th><th class="w-24 number-cell">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr>`;

                // Add Project Name Row
                 if (projectName) {
                    const projectRow = document.createElement('tr');
                    projectRow.classList.add('project-name-row');
                    const cellCount = outputTableHeader.rows[0].cells.length;
                    projectRow.innerHTML = `<td colspan="${cellCount}"><strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> ${projectName}</td>`;
                    outputTableBody.appendChild(projectRow);
                }

                inputSection.querySelectorAll('.item-row').forEach(row => {
                     const desc = row.querySelector('.item-description').value, qty = parseFloat(row.querySelector('.item-quantity').value) || 0, unit = row.querySelector('.item-unit').value || '', price = parseFloat(row.querySelector('.item-price').value) || 0, disc = parseFloat(row.querySelector('.item-discount').value) || 0, total = (price * qty) - disc;
                     if (desc.trim() !== '' || qty !== 0 || price !== 0) {
                         const tr = document.createElement('tr');
                         // Added Quantity cell to output table
                         tr.innerHTML = (docType === 'quotation') ? `<td>${itemIndex++}</td><td>${desc}</td><td class="number-cell">${qty}</td><td>${unit}</td><td class="number-cell">${formatCurrency(price, currencyCode)}</td><td class="number-cell">${formatCurrency(total, currencyCode)}</td>` : `<td>${itemIndex++}</td><td>${desc}</td><td class="number-cell">${qty}</td><td>${unit}</td><td class="number-cell">${formatCurrency(price, currencyCode)}</td><td class="number-cell">${formatCurrency(disc, currencyCode)}</td><td class="number-cell">${formatCurrency(total, currencyCode)}</td>`;
                         outputTableBody.appendChild(tr);
                     }
                 });
                 const totalsContainer = outputSection.querySelector('.output-totals');
                 const inputTotalsContainer = inputSection.querySelector('.totals-container');
                 if (!totalsContainer || !inputTotalsContainer) return;
                  const subTotalStr = inputTotalsContainer.querySelector('.grand-total')?.textContent || '0.00 ‡∏ö‡∏≤‡∏ó'; // Get formatted string directly
                 const discountStr = inputTotalsContainer.querySelector('.total-discount')?.textContent || '0.00 ‡∏ö‡∏≤‡∏ó';
                 const netTotalStr = inputTotalsContainer.querySelector('.net-total')?.textContent || '0.00 ‡∏ö‡∏≤‡∏ó'; // Get formatted string directly
                 const totalWordsStr = inputTotalsContainer.querySelector('.total-in-words')?.textContent || '';

                 // Updated totals HTML - Added discount row for quotation
                 if (docType === 'quotation') {
                     totalsContainer.innerHTML = `
                        <div class="w-full md:w-1/2 lg:w-2/5 text-sm">
                            <div class="flex justify-between py-1">
                                <span>‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
                                <span class="font-medium grand-total">${subTotalStr}</span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                                <span class="font-medium total-discount">${discountStr}</span>
                            </div>
                            <div class="flex justify-between py-2 border-t-2 border-gray-400 mt-1 font-bold text-lg">
                                <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                <span class="net-total">${netTotalStr}</span>
                            </div>
                              <div class="text-right py-1 text-xs text-gray-700">
                                <span class="total-in-words">${totalWordsStr}</span>
                            </div>
                        </div>
                     `;
                 } else {
                     totalsContainer.innerHTML = `
                        <div class="w-full md:w-1/2 lg:w-2/5 text-sm">
                            <div class="flex justify-between py-1">
                                <span>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                                <span class="font-medium grand-total">${subTotalStr}</span>
                            </div>
                            <div class="flex justify-between py-2 border-t-2 border-gray-400 mt-1 font-bold text-lg">
                                <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                <span class="net-total">${netTotalStr}</span>
                            </div>
                              <div class="text-right py-1 text-xs text-gray-700">
                                <span class="total-in-words">${totalWordsStr}</span>
                            </div>
                        </div>
                     `;
                 }

                const notesTermsContainer = outputSection.querySelector('.output-notes-terms');
                const paymentDetailsContainer = outputSection.querySelector('.output-payment-details');
                if (!notesTermsContainer) return;
                if (docType === 'receipt' && paymentDetailsContainer) {
                     const paymentMethod = inputSection.querySelector('input[name="payment-method"]:checked')?.value || 'N/A', paymentDetails = inputSection.querySelector('#receipt-payment-details')?.value || '';
                     paymentDetailsContainer.innerHTML = `<div><h4 class="font-semibold mb-1">‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢:</h4><p class="text-gray-600">${paymentMethod}</p></div><div>${paymentMethod !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' && paymentDetails ? `<h4 class="font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</h4><p class="text-gray-600 whitespace-pre-wrap">${paymentDetails}</p>` : ''}</div>`;
                      notesTermsContainer.innerHTML = `<div><h4 class="font-semibold mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</h4><p class="text-gray-600 whitespace-pre-wrap">${inputSection.querySelector('.notes-input')?.value || ''}</p></div>`;
                } else if (docType === 'invoice') {
                      notesTermsContainer.innerHTML = `<div><h4 class="font-semibold mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</h4><p class="text-gray-600 whitespace-pre-wrap">${inputSection.querySelector('.notes-input')?.value || ''}</p></div><div><h4 class="font-semibold mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</h4><p class="text-gray-600 whitespace-pre-wrap">${inputSection.querySelector('.payment-info-input')?.value || ''}</p></div>`;
                } else {
                     notesTermsContainer.innerHTML = `<div><h4 class="font-semibold mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</h4><p class="text-gray-600 whitespace-pre-wrap">${inputSection.querySelector('.notes-input')?.value || ''}</p></div><div><h4 class="font-semibold mb-1">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</h4><p class="text-gray-600 whitespace-pre-wrap">${inputSection.querySelector('.payment-terms-input')?.value || ''}</p><h4 class="font-semibold mb-1 mt-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</h4><p class="text-gray-600 whitespace-pre-wrap">${inputSection.querySelector('.payment-info-input')?.value || ''}</p></div>`;
                }
                const signaturesContainer = outputSection.querySelector('.output-signatures'); if (!signaturesContainer) return;
                 const issuerName = inputSection.querySelector('.issuer-name-input')?.value || '‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥', approverName = inputSection.querySelector('.approver-name-input')?.value || '...', receiverName = inputSection.querySelector('.receiver-name-input')?.value || '...', senderName = inputSection.querySelector('.sender-name-input')?.value || '‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥', checkerName = inputSection.querySelector('.checker-name-input')?.value || '...';
                 const currentDate = inputSection.querySelector(`#${docType}-date`)?.value || '';
                 const blankDate = '...........................................'; // Blank date placeholder
                if (docType === 'quotation') { signaturesContainer.innerHTML = `<div class="text-center"><p>‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏î‡∏¢</p><div class="signature-box mt-12">(${issuerName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="output-issued-date">${formatDateThai(currentDate)}</span></p></div><div class="text-center"><p>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢</p><div class="signature-box mt-12">(${approverName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${blankDate}</p></div>`; } // Blank approver date
                else if (docType === 'invoice') { signaturesContainer.innerHTML = `<div class="text-center"><p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏• / Receiver Signature</p><div class="signature-box mt-12">(${receiverName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date: ${blankDate}</p></div><div class="text-center"><p>‡∏ú‡∏π‡πâ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏• / Sender</p><div class="signature-box mt-12">(${senderName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date: <span class="output-issued-date">${formatDateThai(currentDate)}</span></p></div><div class="text-center"><p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / Authorized Signature</p><div class="signature-box mt-12">(${approverName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date: ${blankDate}</p></div>`; } // Blank receiver/approver date
                else if (docType === 'receipt') { signaturesContainer.innerHTML = `<div class="text-center"><p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Bill Receiver</p><div class="signature-box mt-12">(${receiverName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date: ${blankDate}</p></div><div class="text-center"><p>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / Approver</p><div class="signature-box mt-12">(${checkerName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date: ${blankDate}</p></div><div class="text-center"><p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / Authorized Signature</p><div class="signature-box mt-12">(${approverName})</div><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date: <span class="output-issued-date">${formatDateThai(currentDate)}</span></p></div>`; } // Blank receiver/checker date
            } else if (docType === 'contract') {
                 const conNum = outputSection.querySelector('.output-contract-number'), conDate = outputSection.querySelector('.output-contract-date'), conScope = outputSection.querySelector('.output-contract-scope'), conTimeline = outputSection.querySelector('.output-contract-timeline'), conPayment = outputSection.querySelector('.output-contract-payment'), conRevisions = outputSection.querySelector('.output-contract-revisions'), conCancel = outputSection.querySelector('.output-contract-cancellation'), conCopyright = outputSection.querySelector('.output-contract-copyright'), conContact = outputSection.querySelector('.output-contract-contact'), conClient = outputSection.querySelector('.output-contract-client-name'), conFree = outputSection.querySelector('.output-contract-freelancer-name'), conSign = outputSection.querySelector('.output-contract-signed-date');
                 if (conNum) conNum.textContent = inputSection.querySelector('#contract-number')?.value || ''; if (conDate) conDate.textContent = formatDateThai(rawConDate); if (conScope) conScope.textContent = inputSection.querySelector('#contract-scope')?.value || ''; if (conTimeline) conTimeline.textContent = inputSection.querySelector('#contract-timeline')?.value || ''; if (conPayment) conPayment.textContent = inputSection.querySelector('#contract-payment')?.value || ''; if (conRevisions) conRevisions.textContent = inputSection.querySelector('#contract-revisions')?.value || ''; if (conCancel) conCancel.textContent = inputSection.querySelector('#contract-cancellation')?.value || ''; if (conCopyright) conCopyright.textContent = inputSection.querySelector('#contract-copyright')?.value || ''; if (conContact) conContact.textContent = inputSection.querySelector('#contract-contact')?.value || ''; if (conClient) conClient.textContent = document.getElementById('customer-company')?.value || '...'; if (conFree) conFree.textContent = inputSection.querySelector('.freelancer-name-input')?.value || document.getElementById('your-company')?.value || '...'; if (conSign) conSign.textContent = formatDateThai(rawConDate);
                 updateCommonOutput(outputSection);
                 // Update signature date for client to blank
                 const clientSigDate = outputSection.querySelector('.output-signatures .text-center:first-of-type p:last-of-type');
                 if (clientSigDate) clientSigDate.textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ...........................................`;

            } else if (docType === 'submission') {
                const subNum = outputSection.querySelector('.output-submission-number'), subProj = outputSection.querySelector('.output-submission-project'), subDate = outputSection.querySelector('.output-submission-date'), subItems = outputSection.querySelector('.output-submission-items'), subNotes = outputSection.querySelector('.output-submission-notes'), subSubmitter = outputSection.querySelector('.output-submission-submitter-name'), subSubmitDate = outputSection.querySelector('.output-submission-submit-date'), subReceiver = outputSection.querySelector('.output-submission-receiver-name');
                 if (subNum) subNum.textContent = inputSection.querySelector('#submission-number')?.value || ''; if (subProj) subProj.textContent = inputSection.querySelector('#submission-project')?.value || ''; if (subDate) subDate.textContent = formatDateThai(docDate); if (subItems) subItems.textContent = inputSection.querySelector('#submission-items')?.value || ''; if (subNotes) subNotes.textContent = inputSection.querySelector('#submission-notes')?.value || ''; if (subSubmitter) subSubmitter.textContent = document.getElementById('your-company')?.value || '...'; if (subSubmitDate) subSubmitDate.textContent = formatDateThai(docDate); if (subReceiver) subReceiver.textContent = inputSection.querySelector('.receiver-ack-name-input')?.value || '...';
                 updateCommonOutput(outputSection);
                  // Update signature date for receiver to blank
                 const receiverSigDate = outputSection.querySelector('.output-signatures .text-center:last-of-type p:last-of-type');
                 if (receiverSigDate) receiverSigDate.textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ...........................................`;
            }
         }

        // --- Document Type Switching ---
        function switchDocType(docType) {
            currentDocType = docType;
            document.querySelectorAll('#doc-type-selector .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#doc-type-selector button[onclick="switchDocType('${docType}')"]`).classList.add('active');
            document.querySelectorAll('.input-section, .doc-output').forEach(section => section.classList.remove('active'));
            const inputSection = document.getElementById(`input-${docType}`);
            const outputSection = document.getElementById(`output-${docType}`);
            if (inputSection) inputSection.classList.add('active');
            if (outputSection) outputSection.classList.add('active');
            updateOutput(docType);
            if(inputSection) inputSection.scrollIntoView({ behavior: 'smooth' });
        }

         // --- NEW FUNCTION to download data as Excel ---
         function downloadExcel() {
             const downloadButton = document.getElementById('download-button');
             const statusDiv = document.getElementById('download-status');
             const docType = currentDocType;
             const inputSection = document.getElementById(`input-${docType}`);

             // Basic validation
             if (!document.getElementById('customer-company').value) {
                 statusDiv.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤`;
                 statusDiv.className = 'status-error'; return;
             }
             let docNumberInput;
             if (['quotation', 'invoice', 'receipt', 'contract', 'submission'].includes(docType)) {
                docNumberInput = inputSection.querySelector(`#${docType}-number`);
                if (!docNumberInput || !docNumberInput.value) {
                     statusDiv.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£`;
                     statusDiv.className = 'status-error'; return;
                 }
             }

             downloadButton.disabled = true;
             statusDiv.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå...'; statusDiv.className = 'status-loading';

             try {
                // --- Define Headers (Columns) - Removed WHT, Added Project Name ---
                const headers = [
                    "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞", // Added Project Name here
                    "‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤",
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢", "‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô", "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)",
                    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡∏≥‡∏£‡∏∞", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏≥‡∏£‡∏∞",
                    "‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏á‡∏≤‡∏ô(‡∏™‡∏±‡∏ç‡∏ç‡∏≤)", "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤(‡∏™‡∏±‡∏ç‡∏ç‡∏≤)", //"‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå(‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö)", // Redundant now with common Project Name
                    "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"
                ];

                // --- Gather Data Object ---
                const dataObject = {};
                const totalsContainer = inputSection.querySelector('.totals-container'); // For Q/I/R

                // Common Data
                dataObject["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = docType;
                dataObject["‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢"] = document.getElementById('your-company').value;
                dataObject["‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"] = document.getElementById('customer-company').value;
                dataObject["‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"] = document.getElementById('customer-contact-person').value;
                 // Get Project Name from relevant input
                 let projectNameInputValue = '';
                 const projectNameInput = inputSection.querySelector(`#${docType}-project-name`);
                 if (projectNameInput) { projectNameInputValue = projectNameInput.value; }
                 else if (docType === 'contract') { projectNameInputValue = inputSection.querySelector('#contract-scope')?.value.split('\n')[0] || ''; } // Use first line of scope for contract
                 else if (docType === 'submission') { projectNameInputValue = inputSection.querySelector('#submission-project')?.value || ''; }
                dataObject["‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏á‡∏≤‡∏ô"] = projectNameInputValue;


                // Specific Data
                if (docType === 'quotation' || docType === 'invoice' || docType === 'receipt') {
                    dataObject["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = inputSection.querySelector(`#${docType}-number`).value;
                    dataObject["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = inputSection.querySelector(`#${docType}-date`).value;
                    dataObject["‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞"] = inputSection.querySelector(`#${docType}-due-date`)?.value || '';
                    dataObject["‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤"] = inputSection.querySelector(`#${docType}-ref-quotation`)?.value || '';
                    dataObject["‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ"] = inputSection.querySelector(`#${docType}-ref-invoice`)?.value || '';
                    dataObject["‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô"] = document.getElementById(`${docType}-currency`).value;
                    
                    // Calculate totals with discount
                    let subTotal = 0;
                    inputSection.querySelectorAll('.item-row').forEach(row => {
                        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                        const price = parseFloat(row.querySelector('.item-price').value) || 0;
                        const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
                        subTotal += (price * quantity) - discount;
                    });
                    
                    let discountPercent = 0;
                    let totalDiscount = 0;
                    let netTotal = subTotal;
                    
                    if (docType === 'quotation') {
                        discountPercent = parseFloat(document.getElementById('quotation-discount-percent')?.value) || 0;
                        totalDiscount = (subTotal * discountPercent) / 100;
                        netTotal = subTotal - totalDiscount;
                    }
                    
                    dataObject["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î"] = subTotal.toFixed(2);
                    dataObject["‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°(%)"] = discountPercent;
                    dataObject["‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"] = totalDiscount.toFixed(2);
                    dataObject["‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥"] = netTotal.toFixed(2);
                    dataObject["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"] = inputSection.querySelectorAll('.item-row').length;
                    dataObject["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"] = inputSection.querySelector('.notes-input')?.value || '';
                    dataObject["‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡∏≥‡∏£‡∏∞"] = inputSection.querySelector('.payment-terms-input')?.value || '';
                    dataObject["‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞"] = inputSection.querySelector('input[name="payment-method"]:checked')?.value || '';
                    dataObject["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏≥‡∏£‡∏∞"] = inputSection.querySelector('#receipt-payment-details')?.value || '';
                } else if (docType === 'contract') {
                    dataObject["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = inputSection.querySelector('#contract-number').value;
                    dataObject["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = inputSection.querySelector('#contract-date').value;
                    dataObject["‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏á‡∏≤‡∏ô(‡∏™‡∏±‡∏ç‡∏ç‡∏≤)"] = inputSection.querySelector('#contract-scope').value; // Keep specific contract field
                    dataObject["‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤(‡∏™‡∏±‡∏ç‡∏ç‡∏≤)"] = inputSection.querySelector('#contract-timeline').value; // Keep specific contract field
                    dataObject["‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡∏≥‡∏£‡∏∞"] = inputSection.querySelector('#contract-payment').value;
                     dataObject["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"] = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:${inputSection.querySelector('#contract-revisions').value}\n‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:${inputSection.querySelector('#contract-cancellation').value}\n‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:${inputSection.querySelector('#contract-copyright').value}\n‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:${inputSection.querySelector('#contract-contact').value}`;
                     dataObject["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î"] = 0;
                     dataObject["‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°(%)"] = 0;
                     dataObject["‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"] = 0;
                     dataObject["‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥"] = 0; // Contract amount might be in payment terms

                } else if (docType === 'submission') {
                    dataObject["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = inputSection.querySelector('#submission-number').value;
                    dataObject["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"] = inputSection.querySelector('#submission-date').value;
                    // dataObject["‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå(‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö)"] = inputSection.querySelector('#submission-project').value; // Already captured in common Project Name
                    dataObject["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"] = inputSection.querySelector('#submission-items').value;
                    dataObject["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"] = inputSection.querySelector('#submission-notes').value;
                    dataObject["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î"] = 0;
                    dataObject["‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°(%)"] = 0;
                    dataObject["‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"] = 0;
                    dataObject["‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥"] = 0; // Submission might not have amount
                }

                // --- Create Excel Data Array (Headers + Data Row) ---
                const excelData = [headers]; // Start with headers
                const dataRow = headers.map(header => dataObject[header] ?? ""); // Map data object to header order, use "" for missing keys
                excelData.push(dataRow);

                // --- Create and Download Excel using SheetJS ---
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // --- Adjust Column Widths (Optional but Recommended) ---
                const colWidths = headers.map((header, index) => {
                    let maxLen = header.length;
                    excelData.slice(1).forEach(row => { // Check data rows for length
                       const cellValue = row[index] ? String(row[index]) : '';
                       // Simple check for multiline text (adjust threshold as needed)
                       const lines = cellValue.split('\n');
                       const lineLengths = lines.map(line => line.length);
                       const maxLineLength = Math.max(...lineLengths);
                       maxLen = Math.max(maxLen, maxLineLength > 50 ? 50 : maxLineLength); // Limit width for very long lines
                    });
                    return { wch: Math.min(maxLen + 2, 60) }; // Add padding, limit max width
                 });
                ws['!cols'] = colWidths;


                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "BillingData"); // Add sheet named "BillingData"

                // Generate filename
                let filename = `${docType}.xlsx`;
                if(dataObject["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"]) {
                    filename = `${docType}_${dataObject["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"].replace(/[^a-zA-Z0-9]/g, '-')}.xlsx`;
                }

                XLSX.writeFile(wb, filename);

                 statusDiv.textContent = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'; statusDiv.className = 'status-success';

             } catch (error) {
                 console.error('Error creating Excel file:', error);
                 statusDiv.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`; statusDiv.className = 'status-error';
             } finally {
                 downloadButton.disabled = false;
                 setTimeout(() => { if (statusDiv.className !== 'status-error') statusDiv.textContent = ''; }, 5000);
             }
         }


         // --- Initialization ---
        function initializeDocumentInputs(docType) {
            const inputSection = document.getElementById(`input-${docType}`); if (!inputSection) return;
            // Set default values only if not already set (from localStorage)
             if (!document.getElementById('your-company').value) document.getElementById('your-company').value = "‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥";
             if (!document.getElementById('your-tax-id').value) document.getElementById('your-tax-id').value = "1-1103-01367-17-2";
             if (!document.getElementById('your-address').value) document.getElementById('your-address').value = "61/315 ‡∏°.3 ‡∏°‡∏ö.‡πÑ‡∏£‡∏°‡∏≠‡∏ô‡∏û‡∏≤‡∏£‡πå‡∏Ñ ‡∏ã.‡∏ö‡∏≤‡∏á‡∏õ‡∏•‡∏≤ 12\n‡∏ñ.‡πÄ‡∏ó‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏ï.‡∏ö‡∏≤‡∏á‡∏õ‡∏•‡∏≤ ‡∏≠.‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏à.‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10540";
             if (!document.getElementById('your-contact').value) document.getElementById('your-contact').value = "083-149-4529, burist2016@gmail.com";

            if (['quotation', 'invoice', 'receipt'].includes(docType)) {
                const itemsContainer = inputSection.querySelector('.items-container');
                const totalsContainer = inputSection.querySelector('.totals-container');
                const notesTermsContainer = inputSection.querySelector('.notes-terms-container');
                const signaturesContainer = inputSection.querySelector('.signatures-container');
                if (!itemsContainer || !totalsContainer || !notesTermsContainer || !signaturesContainer) { console.error(`Init failed: Missing container for ${docType}`); return; }
                if (!itemsContainer.querySelector('.item-row')) {
                    itemsContainer.innerHTML = generateItemRowHTML(docType);
                     const firstRemoveBtn = itemsContainer.querySelector('.remove-item-btn');
                     if (firstRemoveBtn) { firstRemoveBtn.addEventListener('click', () => removeItemRow(firstRemoveBtn)); firstRemoveBtn.setAttribute('data-listener-added', 'true'); }
                }
                itemsContainer.querySelectorAll('.item-row').forEach(row => {
                     row.querySelectorAll('.item-quantity, .item-price, .item-discount').forEach(input => input.addEventListener('input', () => calculateRowTotal(input)));
                     row.querySelectorAll('.item-description, .item-unit').forEach(input => input.addEventListener('input', () => updateOutput(docType)));
                     const removeBtn = row.querySelector('.remove-item-btn');
                     if (removeBtn && !removeBtn.getAttribute('data-listener-added')) { removeBtn.addEventListener('click', () => removeItemRow(removeBtn)); removeBtn.setAttribute('data-listener-added', 'true'); }
                 });
                 // Updated totals HTML initialization - Removed WHT row
                  totalsContainer.innerHTML = `
                    <div class="w-full md:w-1/2 lg:w-2/5 text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="font-medium text-gray-600">${docType === 'quotation' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : '‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'}:</span>
                            <span class="font-semibold text-gray-800 grand-total">0.00 ‡∏ö‡∏≤‡∏ó</span> <!-- Added unit -->
                        </div>
                        <!-- WHT row removed -->
                        <div class="flex justify-between font-bold text-lg border-t pt-1 mt-1 border-gray-300">
                            <span class="text-gray-800">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                            <span class="text-blue-600 net-total">0.00 ‡∏ö‡∏≤‡∏ó</span> <!-- Added unit -->
                        </div>
                         <div class="flex justify-between mt-1">
                            <span class="font-medium text-gray-600 text-xs">‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£:</span>
                            <span class="text-gray-800 text-right total-in-words text-xs"></span>
                        </div>
                    </div>`;

                 // Set default payment info from PDF
                 const defaultPaymentInfo = "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 037-7-427166\n‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û\n‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ";

                if (docType === 'quotation') {
                     totalsContainer.innerHTML = `<div class="text-right"><div class="mb-2"><span class="font-semibold">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô:</span> <span class="grand-total ml-4"></span></div><div class="mb-2"><span class="font-semibold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span> <span class="total-discount ml-4"></span></div><div class="mb-2 text-lg"><span class="font-bold">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span> <span class="net-total ml-4 font-bold"></span></div><div class="text-sm text-gray-600 total-in-words"></div></div>`;
                     notesTermsContainer.innerHTML = `<div><label for="quotation-notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</label><textarea id="quotation-notes" class="notes-input" oninput="updateOutput('quotation'); saveFormData();">* ‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ 30 ‡∏ß‡∏±‡∏ô...\n* ‡∏î‡∏π‡πÅ‡∏• Bug Fixing 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...</textarea></div><div><label for="quotation-payment-terms">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label><textarea id="quotation-payment-terms" class="payment-terms-input" oninput="updateOutput('quotation'); saveFormData();">* ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 1) 30%...\n* ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 2) 40%...\n* ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 3) 30%...</textarea><label for="quotation-payment-info">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label><textarea id="quotation-payment-info" class="payment-info-input" oninput="updateOutput('quotation'); saveFormData();">${defaultPaymentInfo}</textarea></div>`;
                     // Only set default values if not loaded from localStorage
                     const savedData = localStorage.getItem('freelanceDocData');
                     if (!savedData || !JSON.parse(savedData).quotation) {
                         inputSection.querySelector('#quotation-notes').value = "* ‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ 30 ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤\n* ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Bug Fixing) ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏á‡∏≤‡∏ô Phase 1 ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
                         inputSection.querySelector('#quotation-payment-terms').value = "* ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 1) 30% (56,250 ‡∏ö‡∏≤‡∏ó) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô/Design ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô\n* ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 2) 40% (75,000 ‡∏ö‡∏≤‡∏ó) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å (Core Modules) ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÑ‡∏î‡πâ\n* ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 3) 30% (56,250 ‡∏ö‡∏≤‡∏ó) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (UAT) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
                     }
                     signaturesContainer.innerHTML = `<div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:</label><input type="text" class="issuer-name-input" value="‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥" oninput="updateOutput('quotation'); saveFormData();"></div><div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤):</label><input type="text" class="approver-name-input" placeholder="[‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ù‡∏±‡πà‡∏á RSC/‡∏™‡∏£‡∏ö.]" oninput="updateOutput('quotation'); saveFormData();"></div>`;
                 }
                 else if (docType === 'invoice') {
                     notesTermsContainer.innerHTML = `<div><label for="invoice-notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</label><textarea id="invoice-notes" class="notes-input" oninput="updateOutput('invoice')"></textarea></div><div><label for="invoice-payment-info">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label><textarea id="invoice-payment-info" class="payment-info-input" oninput="updateOutput('invoice')">${defaultPaymentInfo}</textarea></div>`;
                     signaturesContainer.innerHTML = `<div><label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•:</label><input type="text" class="receiver-name-input" oninput="updateOutput('invoice')"></div><div><label>‡∏ú‡∏π‡πâ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•/‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á:</label><input type="text" class="sender-name-input" value="‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥" oninput="updateOutput('invoice')"></div><div><label>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</label><input type="text" class="approver-name-input" placeholder="[‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ù‡∏±‡πà‡∏á RSC/‡∏™‡∏£‡∏ö.]" oninput="updateOutput('invoice')"></div>`;
                 }
                 else if (docType === 'receipt') {
                     notesTermsContainer.innerHTML = `<div><label for="receipt-notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</label><textarea id="receipt-notes" class="notes-input" oninput="updateOutput('receipt')"></textarea></div>`;
                     signaturesContainer.innerHTML = `<div><label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</label><input type="text" class="receiver-name-input" oninput="updateOutput('receipt')"></div><div><label>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</label><input type="text" class="checker-name-input" oninput="updateOutput('receipt')"></div><div><label>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</label><input type="text" class="approver-name-input" value="‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥" oninput="updateOutput('receipt')"></div>`;
                 }
                 calculateDocTotals(docType);
            } else if (docType === 'contract') {
                 const signaturesContainer = inputSection.querySelector('.signatures-container');
                 if (signaturesContainer) { signaturesContainer.innerHTML = `<div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á:</label><input type="text" class="freelancer-name-input" value="‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥" oninput="updateOutput('contract')"></div><div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤):</label><input type="text" class="client-name-input" placeholder="[‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤]" oninput="updateOutput('contract')"></div>`; }
            } else if (docType === 'submission') {
                 const signaturesContainer = inputSection.querySelector('.signatures-container');
                  if (signaturesContainer) { signaturesContainer.innerHTML = `<div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô:</label><input type="text" class="submitter-name-input" value="‡∏ô‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ä‡∏≤‡∏ï‡∏¥‡∏ä‡∏≥‡∏ô‡∏¥" oninput="updateOutput('submission')" readonly></div><div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏):</label><input type="text" class="receiver-ack-name-input" placeholder="[‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö]" oninput="updateOutput('submission')"></div>`; }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load saved data first
            loadFormData();
            
            const today = new Date().toISOString().split('T')[0];
            ['quotation-date', 'invoice-date', 'receipt-date', 'invoice-due-date', 'contract-date', 'submission-date'].forEach(id => { const el = document.getElementById(id); if (el && !el.value) el.value = today; }); // Only set today if no saved value
            ['quotation', 'invoice', 'receipt', 'contract', 'submission'].forEach(initializeDocumentInputs);
            calculateDocTotals(currentDocType); updateOutput(currentDocType);
            
            // Add auto-save on input changes
            ['your-company', 'your-tax-id', 'your-address', 'your-contact', 'customer-company', 'customer-tax-id', 'customer-contact-person', 'customer-address', 'customer-tel'].forEach(id => { 
                const el = document.getElementById(id); 
                if (el) {
                    el.addEventListener('input', () => {
                        updateOutput(currentDocType);
                        saveFormData(); // Auto-save
                    });
                }
            });
            
            ['quotation-currency', 'invoice-currency', 'receipt-currency'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', () => { updateAllCalculations(); saveFormData(); }); });
            
            // Add event listener for discount percent input
            const discountPercentEl = document.getElementById('quotation-discount-percent');
            if (discountPercentEl) {
                discountPercentEl.addEventListener('input', () => {
                    calculateDocTotals('quotation');
                    updateOutput('quotation');
                    saveFormData();
                });
            }
            
            // Add auto-save for all document inputs
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (!el.getAttribute('data-autosave-listener')) {
                    el.addEventListener('change', saveFormData);
                    el.setAttribute('data-autosave-listener', 'true');
                }
            });

             // Set default items based on PDF for Quotation initially (only if no saved data)
            const savedData = localStorage.getItem('freelanceDocData');
            if (currentDocType === 'quotation' && (!savedData || !JSON.parse(savedData).quotation || !JSON.parse(savedData).quotation.items)) {
                const itemsContainer = document.querySelector('#input-quotation .items-container');
                itemsContainer.innerHTML = ''; // Clear default empty row first
                const defaultItems = [
                    { desc: "‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Planning & Design)", qty: 1, unit: "‡∏á‡∏≤‡∏ô", price: 36000, disc: 0 },
                    { desc: "‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å (Core System Development)", qty: 1, unit: "‡∏á‡∏≤‡∏ô", price: 90000, disc: 0 },
                    { desc: "‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ Dashboard ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° (Dashboard & Features)", qty: 1, unit: "‡∏á‡∏≤‡∏ô", price: 36000, disc: 0 },
                    { desc: "‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (UAT) ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (UAT Support & Revision)", qty: 1, unit: "‡∏á‡∏≤‡∏ô", price: 18000, disc: 0 },
                    { desc: "Cloud Hosting/Server", qty: 5, unit: "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", price: 1500, disc: 0 } // Assuming 5 months based on total
                ];
                defaultItems.forEach(item => {
                     itemsContainer.insertAdjacentHTML('beforeend', generateItemRowHTML('quotation'));
                     const newRow = itemsContainer.lastElementChild;
                     newRow.querySelector('.item-description').value = item.desc;
                     newRow.querySelector('.item-quantity').value = item.qty;
                     newRow.querySelector('.item-unit').value = item.unit;
                     newRow.querySelector('.item-price').value = item.price;
                     newRow.querySelector('.item-discount').value = item.disc;
                     calculateRowTotal(newRow.querySelector('.item-quantity')); // Trigger calculation
                     addEventListenersToRow(newRow); // Add listeners using the defined function
                 });
                 // Re-calculate totals and update output after adding defaults
                 calculateDocTotals('quotation');
                 updateOutput('quotation');
            }
        });
    </script>

</body>
</html>